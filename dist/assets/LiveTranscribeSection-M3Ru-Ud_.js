import{r as a,j as t,B as E,I as T,L as _}from"./index-CjafWCjW.js";import{W as M,A,u as k,D as C,E as L}from"./useTranscription-lq7WLSPY.js";const O=new Set(["session_start","session_end","partial","final","translation","error","info"]),U=(n,s)=>{const o=typeof n.type=="string"?n.type:"info",c=O.has(o)?o:"info",d=n.sessionId??n.session_id??s,g=n.text??n.final_text,u=n.downloadUrl??n.download_url,m=Array.isArray(n.segments)?n.segments:void 0;return{type:c,text:g,language:typeof n.language=="string"?n.language:void 0,sessionId:d,downloadUrl:u,segments:m,raw:n}};class z{ws;onMessage;onError;language="English";sessionId;constructor(s){this.onMessage=s?.onMessage,this.onError=s?.onError,s?.language&&(this.language=s.language)}connect(s){s&&(this.language=s),this.sessionId=void 0;const o=`&token=${encodeURIComponent(A)}`,c=`${M}/live-transcribe?lang=${encodeURIComponent(this.language)}${o}`;this.ws=new WebSocket(c),this.ws.onopen=()=>{this.sendJSON({type:"info",language:this.language})},this.ws.onmessage=d=>{try{const g=JSON.parse(d.data),u=U(g,this.sessionId);u.sessionId&&(this.sessionId=u.sessionId),this.onMessage?.(u)}catch{this.onMessage?.({type:"partial",text:String(d.data),language:this.language,sessionId:this.sessionId})}},this.ws.onerror=()=>{const d=new Error("WebSocket error");this.onError?.(d)},this.ws.onclose=()=>{this.ws=void 0,this.sessionId=void 0}}disconnect(){this.ws&&this.ws.readyState<=1&&this.ws.close(),this.ws=void 0,this.sessionId=void 0}sendAudioChunk(s){if(!(!this.ws||this.ws.readyState!==WebSocket.OPEN)){if(s instanceof Blob){s.arrayBuffer().then(o=>this.ws?.send(o));return}this.ws.send(s)}}sendJSON(s){!this.ws||this.ws.readyState!==WebSocket.OPEN||this.ws.send(JSON.stringify(s))}getSessionId(){return this.sessionId}requestStop(){!this.ws||this.ws.readyState!==WebSocket.OPEN||this.ws.send(JSON.stringify({text:"stop"}))}}const D=({className:n=""})=>{const{state:s,dispatch:o}=k(),[c,d]=a.useState(s.language),[g,u]=a.useState(!1),[m,w]=a.useState(!1),[I,h]=a.useState(null),[R,x]=a.useState(""),S=a.useRef(null),l=a.useRef(null),v=a.useRef(void 0),i=a.useRef(null);a.useEffect(()=>{l.current?.disconnect(),v.current=void 0,x("");const r=new z({language:c,onMessage:e=>{if(i.current&&(clearTimeout(i.current),i.current=null),e.type==="error"&&e.text){h(e.text);return}if(w(!1),e.sessionId&&v.current!==e.sessionId&&(v.current=e.sessionId,o({type:"add_session",payload:{id:e.sessionId,language:c,createdAt:Date.now()}}),o({type:"set_current",payload:e.sessionId}),x("")),e.type==="session_end"&&e.text)x(e.text);else if(e.type==="final"&&e.text){const y=e.text??"";x(p=>p?`${p}
${y}`:y)}else e.type==="partial"&&e.text&&x(e.text);(e.type==="final"||e.type==="session_end")&&e.text&&e.sessionId&&o({type:"update_transcript",payload:{id:e.sessionId,transcript:e.text}})},onError:e=>h(e.message)});return l.current=r,()=>{l.current?.disconnect(),i.current&&(clearTimeout(i.current),i.current=null)}},[c,o]),a.useEffect(()=>()=>{l.current?.disconnect(),S.current?.stop(),i.current&&(clearTimeout(i.current),i.current=null)},[]);const N=async()=>{h(null),w(!0),i.current&&(clearTimeout(i.current),i.current=null);try{l.current?.connect(c);const r=await navigator.mediaDevices.getUserMedia({audio:!0}),y=["audio/webm;codecs=opus","audio/webm","audio/mp4","audio/aac"].find(f=>{if(typeof MediaRecorder>"u")return!1;const b=MediaRecorder;return typeof b.isTypeSupported=="function"?b.isTypeSupported(f):!1}),p=y?new MediaRecorder(r,{mimeType:y}):new MediaRecorder(r);S.current=p,p.ondataavailable=f=>{f.data&&f.data.size>0&&l.current?.sendAudioChunk(f.data)},p.onstop=()=>{r.getTracks().forEach(f=>f.stop())},p.start(500),u(!0)}catch(r){const e=r instanceof Error?r.message:"Microphone access failed";h(e),l.current?.disconnect()}finally{w(!1)}},j=()=>{S.current?.stop(),l.current?.requestStop(),i.current=setTimeout(()=>{l.current?.disconnect()},2e3),u(!1)};return t.jsxs("section",{className:`bg-gray-800 rounded-xl p-4 sm:p-6 ${n}`,"aria-label":"Real-time translation",children:[t.jsx("h2",{className:"text-xl font-semibold text-white mb-4",children:"Real-time Translation"}),t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 items-center",children:[t.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[t.jsx("label",{htmlFor:"language-toggle",className:"text-gray-300",children:"Language"}),t.jsx("select",{id:"language-toggle",value:c,onChange:r=>d(r.target.value),className:"bg-gray-900 text-gray-200 border border-gray-700 rounded-lg px-3 py-2","aria-label":"Select live transcription language",children:C.map(r=>t.jsx("option",{value:r,children:r},r))})]}),g?t.jsxs(E,{variant:"secondary",onClick:j,className:"flex items-center gap-2",children:[t.jsx(T,{name:"microphone",size:20,"aria-hidden":!0})," Stop"]}):t.jsxs(E,{variant:"primary",onClick:N,className:"flex items-center gap-2",children:[t.jsx(T,{name:"microphone",size:20,"aria-hidden":!0})," Start"]})]}),m&&t.jsx(_,{size:"md",text:"Connecting to live transcription..."}),I&&t.jsx(L,{message:I,onDismiss:()=>h(null)}),t.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 text-gray-300 leading-relaxed min-h-[120px]",children:[t.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Live Text"}),t.jsx("div",{role:"log","aria-live":"polite","aria-relevant":"additions text",className:"max-h-[240px] overflow-y-auto whitespace-pre-wrap",tabIndex:0,children:R||"Speak into your microphone to see real-time results."})]})]})]})};export{D as default};
